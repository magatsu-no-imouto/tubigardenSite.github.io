<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin User Page</title>
    <style>
 body, h1, h2, b, p {
    margin: 0;
    padding: 0;
}
body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display:inline-flexbox;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
    background-image: url('media/tubigan.jpg'); 
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
    background-size: cover; 
    background-position: center;
    background-repeat: no-repeat; 
   
   
        }
        .header-content {
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #fff;
    }
        header.style1 {
        display: flex;
        background-color: #007BFF;
        color: #fff;
        text-align: center;
        padding: 5px ;
        }
        header.style1 a {
         display: inline-block;
         background-color: #fff;
         color: #007BFF;
         padding: 10px 20px;
         text-decoration: none;
         border-radius: 5px;
         margin-top: 20px;
         font-weight: bold;
        }
        div.style1 {
    padding: 50px 0px 0px 155px;
}

        header.style2 {
           background-color: #7cafc9;
           color: #ffffff;
          text-align: center;
          padding: 5px ;
        }
        header.style2 a {
         display: inline-block;
         background-color: #fff;
         color: #007BFF;
         padding: 10px 20px;
         text-decoration: none;
         border-radius: 5px;
         margin-top: 20px;
         font-weight: bold;
        }
        
        header.s2 nav{
          display: flex;
          justify-content: center;
          align-items: center;
        }
        header.style2 nav a{
          display: inline-block;
          padding: 10px 20px;
          text-decoration: none;
          color: #ff0202;
          background-color: rgb(226, 226, 83);
          border-radius: 35px;
          margin: 0 10px;
          transition: cubic-bezier(0.075, 0.82, 0.165, 1);
        }
        header.style2 nav a:hover{
          background-color: #007BFF;

        }
        header {
      flex: none;
      position: relative;
      overflow: hidden;
    }
    header > img {
    height: 100px;
    width: auto;
    margin-right:auto;
    margin-left: - auto;
}
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        footer {
         text-align: center;
         background-color: #333;
         color: #fff;
         padding: 0px ;
         margin-top: 200px;
        }
        .table-container {
    width: 100%;
    height: 200px;
    margin: 0 auto;
    overflow-x: auto;
    overflow-y: auto;
    background-color: #fafafa;
    border: 1px;
        }
        select{
            display:block;
            margin:fixed;
        }
        .hiddenSel{
            visibility: hidden;
            display: block;
            margin-bottom: 0px;
        }
        .btn-container {
            text-align: left;
        }

        .btn {
            display: inline-block;
            padding: 10px 30px;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        label {
            display: block;
            margin-bottom: 10px;
        }

@keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
}

@keyframes fadeOut {
    0% { opacity: 1; }
    100% { opacity: 0; }
}
.container {
            max-width: 50%;
            margin: 0 auto;
            padding: 20px;
        }
.op{
   
    color: #cfe609;
  padding: 8px 10px;
  text-decoration: none;
  display: block;
  transition: 0.1s;
  background-color: #007bff;
  color: #ffffff;
  font-size: 15px;
  position: absolute;
  z-index: 1;
  min-width: 200px;
  border: 2px solid #080808;
  border-radius: 15px 15px 15px 15px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}
.fade-element {
    background-color: white;
    width: 100%;
    padding: 10px;
    margin: 0 auto;
    border: 1px solid #ccc;
    border-radius: 4px;
    opacity: 0; /* Start with fully transparent */
    transition: opacity 1s ease-in-out; /* Duration, timing function, and fill-mode */
}
.fade-in {
    animation: fadeIn 0.5s ease-in-out forwards;
}

.fade-out{
    animation: fadeOut 0.5s ease-in-out forwards;
}
.main-heading{
    font-size: 20px;
        display: inline-block;
justify-content: center;
text-align: center;
margin-right: 340px;

}
.headText{
        font-size: 15px;
        display: inline-block;
justify-content: center;
text-align: center;
margin-right: 340px;
}



    </style>
</head>
<body>
    <header class="style1">
        <img src="media/5.png" alt="logo">

        <div class="style1">
        <h1 class="main-heading"> Tubigan Garden Resort</h1>
        <p class="headText">Tubigan Garden Resort located at Paliparan 3, Dasmari√±as, Cavite | ùôîùôäùôêùôç ùôâùôÄùôìùôè ùòºùòøùôëùôÄùôâùôèùôêùôçùôÄ ùôéùôãùôäùôè‚ùó</p>
        <p class="headText">Affordable Summer PlayGround</p><br>
        </div>
    </header>
    <header class="style2">
        <nav>
        <a href="Tubigan Garden Resort.html">Home</a>
        <a href= "reservation.html">Reserve</a>
        <a href="Room.html">Rooms</a>
        <a href= "LogIn.html">Log Out</a>
    </nav>
    </header>
    <br>
    <h3 id="homessage">Welcome, [USERNAME]!</h3>
    <h2 id="beeglabel">Reservations Status</h2>
    
    <div class="table-container">
        <table id="StatusTable">
            <thead>
                <tr>
                    <th>Booked Reservation Date</th>
                    <th>Check-In Date</th>
                    <th>Check-Out Date</th>
                    <th>Reservation ID</th>
                    <th>Party Size</th>
                    <th>Chosen Amenity</th>
                    <th>Tour Type</th>
                    <th>Price</th>
                    <th>Payment Method</th>
                </tr>
            </thead>
            <tbody id="reservation-table">
                <!-- Reservation datum will be displayed here -->
            </tbody>
        </table>
    </div>
    <form>
        <select id="roomName" class="hiddenSel">
        </select>
    </form>
    <div class="container">
    
        <select class="op " id="selectID">
            <option>--Select Reservation ID to view--</option>
            <!--Load IDs here-->
        
        </select>
        <br>
        <br>
        <div class="btn-container">
        <button class="btn" id="buttBreak" onclick="appear()">Breakdown Fees</button>
        <button class="btn" onclick="window.location.replace('reservation.html')">Reserve Another</button>
        </div> 
        <div class="fade-element" id="cont">
        <label id="meem"></label>
        <label id="bill"></label>
        <label id="pax"></label>
        <label id="cax"></label>
        <label id="fullbal"></label>
        <label id="totPrice"></label>
        <label id="runbal"></label>
    </div> 
</div>
    <script>
        let res,id
        let ticketP=300
        const sel=document.getElementById('roomName')
        fetch('/current_Mem').then(response=>{
            if(response.ok){
                return response.json()
            }else{
                return window.location.replace('LogIn.html')
            }
        }).then(data=>{
            document.getElementById('homessage').innerHTML=`Welcome, ${data.mID}!`
            id=data.mID
            searchRs()
        })

        fetch('room-data').then(response=>{
            if(response.ok){
                return response.json()
            }else{
                throw new Error('error fetching data')
            }
        }).then(data=>{
            for(const item of data){
                const op=document.createElement('option')
                op.text=item.roomName
                op.value=item.roomCost
                sel.appendChild(op)
            }
        })

        async function searchRs(){
            const response=await fetch(`/searchResCust?resmID=${id}`)
            const result=await response.json()
            if(response.ok){
                const tbl=document.getElementById('reservation-table')
                if(Array.isArray(result)){
                    for(const item of result){
                    const select=document.getElementById('selectID')
                        const r=document.createElement('tr')
                   r.innerHTML=`
                   <td>${item.resBookeDate}</td>
                   <td>${item.resCheckinDate}</td>
                   <td>${item.resCheckoutDate}</td>
                   <td>${item.resID}</td>
                   <td>${item.resPax}</td>
                   <td>${item.resRoomName}</td>
                   <td>${item.resTour}</td>
                   <td>${item.resPayStat}</td>
                   <td>${item.resStat}</td>
                   <td><button class="btn" onclick="move('${item.resID}','change')">Change Rooms</button></td>
                   <td><button class="btn" onclick="move('${item.resID}','resched')">Reschedule</button></td>
                   `
                   if(item.resPayStat!="Paid"){
                    r.innerHTML+=`<td><button class="btn" onclick="move('${item.resID}','payment')">Pay for Reservation</button></td>`
                   }
                   const op=document.createElement('option')
                   op.textContent=item.resID
                   op.value=item.resID
                   select.appendChild(op)
                   tbl.appendChild(r)
                    }
                }else{
                    const select=document.getElementById('selectID')
                   const r=document.createElement('tr')
                   r.innerHTML=`
                   <td>${result.resBookeDate}</td>
                   <td>${result.resCheckinDate}</td>
                   <td>${result.resCheckoutDate}</td>
                   <td>${result.resID}</td>
                   <td>${result.resPax}</td>
                   <td>${result.resRoomName}</td>
                   <td>${result.resTour}</td>
                   <td>${result.resPayStat}</td>
                   <td>${result.resStat}</td>
                   <td><button class="btn" onclick="move('${result.resID}','change')">Change Rooms</button></td>
                   <td><button class="btn" onclick="move('${result.resID}','resched')">Reschedule</button></td>
                   `
                   if(result.resPayStat!="Paid"){
                    r.innerHTML+=`<td><button class="btn" onclick="move('${result.resID}','payment')">Pay for Reservation</button></td>`
                   }
                   const op=document.createElement('option')
                   op.textContent=result.resID
                   op.value=result.resID
                   const selA=result.resID
                   select.appendChild(op)
                   for(let i=0; i<select.options.length;i++){
                    if(select.options[i].text==selA){
                        select.selectedIndex=i
                        break;
                    }
                   }
                   tbl.appendChild(r)
                   res=result.resID
                   searchSel()
                }
            }
        }

        async function move(ID,token){
            const next={
                        resID:ID
                    }
                    try{
                        const response=await fetch('/applyCurrentRes',{
                        method:'POST',
                        headers:{
                            'Content-Type':'application/json'
                        },
                        body:JSON.stringify(next)
                    })
                    if(response.ok){
                        if(token=="change"){
                            alert("Changing Rooms.")
                            window.location.replace("reservRoomChange.html")
                        }else 
                        if(token=="resched"){
                            alert("Changing Schedules")
                            window.location.replace("reschedule.html")
                        }else
                        if(token=="payment"){
                            alert("Paying Balances.")
                            window.location.replace("paymentGate.html")
                        }
                    }
                    }catch(err){
                        console.log(err)
                        alert('someone tripped over the wires!');
                    }
        }
        let hideToken=false;
        function appear(){
            document.getElementById('cont').classList.add('fade-in')
            document.getElementById('cont').classList.remove('fade-out')
            document.getElementById('buttBreak').onclick=function(){
                hideToken=true
                disappear()
            }
        }
        function disappear(){
            document.getElementById('cont').classList.add('fade-out')
            document.getElementById('cont').classList.remove('fade-in')
            document.getElementById('cont').addEventListener('animationend',function(){
                if (hideToken){
                    hideToken=false
                }
            },{once:true})
            document.getElementById('buttBreak').onclick=function(){
                hideToken=false
                appear()
            }
        }

        let arrayR=[]
        
        document.getElementById('selectID').addEventListener('change',function(){
            arrayR=[]
            res=document.getElementById('selectID').value
            searchSel()
        })

        async function searchSel(){
            const response=await fetch(`/searchRes?resID=${res}`)
            const result=await response.json()
            const response2=await fetch(`/searchRunRes?runresID=${res}`)
            const result2=await response2.json()
            if(response.ok){
                document.getElementById('meem').innerHTML=`here is a breakdown of your reservation:`
                console.log(Array.isArray(result.resRoomName))
                if(Array.isArray(result.resRoomName)){
                    for(const item of result.resRoomName){
                        let roomPrice
                        for(const e of sel.options){
                            if(item==e.text){
                                arrayR.push({roomName:item,price:e.value})
                                break;
                            }
                        }                        
                    }
                }else{
                    console.log("False "+result.resRoomName)
                    for(const e of sel.options){
                        console.log(result.resRoomName+" "+e.text)
                            if(result.resRoomName==e.text){
                                arrayR.push({roomName:result.resRoomName,
                                    price:e.value})
                                break;
                            }
                        } 
                }
                console.log(arrayR)
                    document.getElementById('bill').innerHTML=arrayR.map(item=>`${item.roomName} --- P${item.price}`).join('<br>')
                    document.getElementById('pax').innerHTML=`${result.resPax} Adult --- P${ticketP*result.resPax}`
                    if(result.resCax!=0){
                        document.getElementById('cax').innerHTML=`${result.resCax} Children --- P${ticketP*result.resCax} deduction`
                    }else{
                        document.getElementById('cax').innerHTML=``
                    }
                    if(response2.ok){
                        let remI=result2.runresPrice-result.resPrice
                        if(remI==0){
                            document.getElementById('fullbal').innerHTML=``
                        }else{
                            document.getElementById('fullbal').innerHTML=`Running Balance<br>P${remI}`
                        }
                        
                        document.getElementById('totPrice').innerHTML=`Total price <br>P${result2.runresPrice}`
                        document.getElementById('runbal').innerHTML=`Paid: <br>
                        P${result2.runresPrice-result2.runresBal}<br>Remaining Balance:<br>P${result2.runresBal}`
                    }else{
                        document.getElementById('totPrice').innerHTML=`Total price <br>P${result.resPrice}`
                        document.getElementById('runbal').innerHTML=``
                    }
                    appear()
            }else{
                document.getElementById('meem').innerHTML=``
                document.getElementById('bill').innerHTML=``
                document.getElementById('pax').innerHTML=``
                document.getElementById('cax').innerHTML=``
                document.getElementById('totPrice').innerHTML=``
                document.getElementById('runbal').innerHTML=``
                disappear()
            }
        }
    </script>
    <footer>
        <p>&copy; (2014) Tubigan Garden Resort</p>
    </footer>
</body>
